
# Домашнее задание к занятию «Микросервисы: принципы»

Вы работаете в крупной компании, которая строит систему на основе микросервисной архитектуры.
Вам как DevOps-специалисту необходимо выдвинуть предложение по организации инфраструктуры для разработки и эксплуатации.

## Задача 1: API Gateway 

Предложите решение для обеспечения реализации API Gateway. Составьте сравнительную таблицу возможностей различных программных решений. На основе таблицы сделайте выбор решения.

Решение должно соответствовать следующим требованиям:
- маршрутизация запросов к нужному сервису на основе конфигурации,
- возможность проверки аутентификационной информации в запросах,
- обеспечение терминации HTTPS.

Обоснуйте свой выбор.

### ОТВЕТ

API Gateway используется для скрытия внутренней сложности системы от внешних потребителей, обеспечения авторизации, логирования. Позволяет избежать версионирования эндпоинтов и упростить взаимодействие клиентов с системой.

#### Сравнительная таблица решений API Gateway:

| Критерий                     | Kong                                               | Nginx                                                           | Traefik                                                                       | Ambassador                                              |
| ---------------------------- | -------------------------------------------------- | --------------------------------------------------------------- | ----------------------------------------------------------------------------- | ------------------------------------------------------- |
| **Маршрутизация запросов** | Маршрутизация на основе конфигурации (Admin API) | Маршрутизация на основе конфигурации (конфигурационные файлы) | Маршрутизация на основе конфигурации (автоматическая для Kubernetes/Docker) | Маршрутизация на основе конфигурации (для Kubernetes) |
| **Проверка аутентификации**  | Плагины OAuth2, JWT, Basic Auth, Key Auth | ⚠️ Требует дополнительных модулей (nginx-auth-request) | Встроенная поддержка OAuth2, Basic Auth | Поддержка аутентификации через плагины |
| **Терминация HTTPS** | Поддержка SSL/TLS | Поддержка SSL/TLS (включая SNI) | Поддержка SSL/TLS (автоматическое управление сертификатами Let's Encrypt) | Поддержка SSL/TLS                                     |
| **Производительность** | Высокая (на базе Nginx/OpenResty) | Очень высокая | Высокая | Высокая |
| **Простота конфигурации** | ⚠️ Требует базу данных (PostgreSQL/Cassandra) | Простые конфигурационные файлы | Автоматическая конфигурация | ⚠️ Требует Kubernetes |
| **Расширяемость** | Богатая экосистема плагинов | ⚠️ Через модули и Lua-скрипты |Middleware система | Плагины и фильтры |
| **Мониторинг и логирование** | Встроенные метрики и логирование | Встроенные метрики и логирование | Встроенные метрики и  логирование | Интеграция с системами мониторинга |
| **Сообщество и поддержка** | Активное сообщество, коммерческая поддержка | Огромное сообщество | Активное сообщество | Активное сообщество |

Как более простое решение с базовой функциональностью подойдет Nginx, но для крупной компании Kong предоставляет больше возможностей для управления API. Traefik больше подходит для систем на Kubernetes.

**Kong** отлично подходит для решения задачи.
1. **Соответствие требованиям:**
   - Маршрутизация: гибкая система маршрутизации на основе конфигурации через Admin API или декларативную конфигурацию
   - Аутентификация: богатый набор плагинов для различных методов аутентификации (JWT, OAuth2, Key Auth, Basic Auth)
   - HTTPS: полная поддержка терминации SSL/TLS с возможностью автоматического управления сертификатами

2. **Преимущества для микросервисной архитектуры:**
   - Скрывает внутреннюю сложность системы от внешних потребителей, что соответствует рассмотренным принципам проектирования
   - Обеспечивает централизованную аутентификацию и авторизацию
   - Поддерживает логирование запросов
   - Позволяет избежать версионирования эндпоинтов, скрывая изменения внутренней архитектуры

3. **Практические преимущества:**
   - Высокая производительность
   - Экосистема плагинов для расширения функциональности
   - Хорошая документация и активное сообщество
   - Возможность использования как в облаке, так и на своем железе

## Задача 2: Брокер сообщений

Составьте таблицу возможностей различных брокеров сообщений. На основе таблицы сделайте обоснованный выбор решения.

Решение должно соответствовать следующим требованиям:
- поддержка кластеризации для обеспечения надёжности,
- хранение сообщений на диске в процессе доставки,
- высокая скорость работы,
- поддержка различных форматов сообщений,
- разделение прав доступа к различным потокам сообщений,
- простота эксплуатации.

Обоснуйте свой выбор.

### ОТВЕТ

Для микросервисной архитектуры важна событийная модель взаимодействия, которая уменьшает связность системы и обеспечивает высокую гибкость. Брокер сообщений является ключевым компонентом для реализации асинхронного взаимодействия между сервисами.

#### Сравнительная таблица брокеров сообщений:

| Критерий | RabbitMQ | Apache Kafka | Apache Pulsar | Redis Streams |
| -------------------------------- | ----------------------------------------------------- | ------------------------------------------------------ | ------------------------------------------------- | ---------------------------------------------- |
| **Кластеризация для надёжности** | Поддержка кластеров, зеркалирование очередей | Распределённая архитектура, репликация партиций | Многоуровневая архитектура с репликацией | Redis Cluster, репликация |
| **Хранение на диске** | Персистентные очереди, подтверждение доставки | Все сообщения хранятся на диске | Хранение в BookKeeper | ⚠️ Опционально (AOF/RDB) |
| **Скорость работы** | Высокая (до сотен тысяч сообщений/сек) | Очень высокая (миллионы сообщений/сек) | Высокая (близка к Kafka) | Очень высокая (в памяти) |
| **Форматы сообщений** | Любые (бинарные, JSON, XML, текст) | Бинарный формат, любой payload | Любые форматы | Любые форматы |
| **Разделение прав доступа** | Пользователи, виртуальные хосты, права на очереди   | ACL, SASL, интеграция с LDAP/Kerberos | Многоуровневая авторизация, роли | ⚠️ Базовые ACL Redis |
| **Простота эксплуатации** | Простая установка и настройка, хорошая документация | ⚠️ Требует понимания партиций, топиков, консьюмер-групп | ⚠️ Более сложная архитектура (BookKeeper + Broker) | Простая, знакомая многим |
| **Гарантии доставки** | At-least-once, at-most-once, exactly-once | At-least-once, exactly-once семантика | Гарантии доставки через BookKeeper | ⚠️ Зависит от конфигурации |
| **Масштабируемость** | Горизонтальное масштабирование | Горизонтальное масштабирование | Горизонтальное масштабирование | Горизонтальное масштабирование через кластер |
| **Сообщество и поддержка** | Зрелое решение, большое сообщество | Очень активное сообщество | ⚠️ Меньше сообщество, чем Kafka | Активное сообщество |

Для крупной компании с микросервисной архитектурой RabbitMQ представляет оптимальный баланс между функциональностью, надёжностью и простотой эксплуатации.

Для очень высоких нагрузок и потоковой обработки данных стоило бы выбрать **Apache Kafka**, но потребуется больше экспертизы для эксплуатации
Для самых простых сценариев подойдет **Redis Streams**, но может быть менее надёжен для критичных систем

1. **Соответствие всем требованиям:**
   - **Кластеризация:** Поддержка кластеров с зеркалированием очередей обеспечивает высокую надёжность и отказоустойчивость
   - **Хранение на диске:** Персистентные очереди гарантируют сохранность сообщений даже при перезапуске брокера
   - **Высокая скорость:** Способен обрабатывать сотни тысяч сообщений в секунду, что достаточно для большинства корпоративных задач
   - **Форматы сообщений:** Поддерживает любые форматы (JSON, XML, бинарные данные)
   - **Разделение прав доступа:** Гибкая система управления пользователями, виртуальными хостами и правами доступа к очередям
   - **Простота эксплуатации:** Простая установка, понятная архитектура, отличная документация и инструменты управления (Management UI)

2. **Преимущества для микросервисной архитектуры:**
   - Поддержка различных паттернов обмена сообщениями (point-to-point, publish/subscribe, routing)
   - Гибкая маршрутизация сообщений
   - Поддержка приоритетов сообщений и TTL
   - Возможность реализации как синхронных, так и асинхронных взаимодействий

3. **Практические преимущества:**
   - Зрелое и стабильное решение с большим сообществом
   - Хорошая интеграция с различными языками программирования
   - Удобный веб-интерфейс для мониторинга и управления
   - Простота настройки и поддержки по сравнению с Kafka
   - Подходит для большинства сценариев использования в микросервисной архитектуре

